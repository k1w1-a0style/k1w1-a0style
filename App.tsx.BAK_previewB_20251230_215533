import "react-native-gesture-handler";
import "./polyfills";
import "react-native-get-random-values";
import "react-native-reanimated";

import React from "react";
import { LogBox } from "react-native";

import { NavigationContainer } from "@react-navigation/native";
import { createDrawerNavigator } from "@react-navigation/drawer";
import { createBottomTabNavigator } from "@react-navigation/bottom-tabs";
import { createNativeStackNavigator } from "@react-navigation/native-stack";
import { GestureHandlerRootView } from "react-native-gesture-handler";
import { SafeAreaProvider, useSafeAreaInsets } from "react-native-safe-area-context";

import { StatusBar } from "expo-status-bar";
import { Ionicons } from "@expo/vector-icons";

import { theme } from "./theme";

import { TerminalProvider } from "./contexts/TerminalContext";
import { AIProvider } from "./contexts/AIContext";
import { ProjectProvider } from "./contexts/ProjectContext";
import { GitHubProvider } from "./contexts/GitHubContext";

import ChatScreen from "./screens/ChatScreen";
import CodeScreen from "./screens/CodeScreen";
import TerminalScreen from "./screens/TerminalScreen";
import SettingsScreen from "./screens/SettingsScreen";
import ConnectionsScreen from "./screens/ConnectionsScreen";
import AppInfoScreen from "./screens/AppInfoScreen";
import GitHubReposScreen from "./screens/GitHubReposScreen";
import DiagnosticScreen from "./screens/DiagnosticScreen";
import AppStatusScreen from "./screens/AppStatusScreen";
import PreviewScreen from "./screens/PreviewScreen";
import EnhancedBuildScreen from "./screens/EnhancedBuildScreen";

import PreviewFullscreenScreen from "./screens/PreviewFullscreenScreen";

import CustomHeader from "./components/CustomHeader";
import { CustomDrawerContent } from "./components/CustomDrawer";
import { ErrorBoundary } from "./components/ErrorBoundary";

LogBox.ignoreLogs(["Require cycle:", "VirtualizedLists should never be nested"]);

const Tab = createBottomTabNavigator();
const Drawer = createDrawerNavigator();
const Stack = createNativeStackNavigator();

const TabNavigator = () => {
  const insets = useSafeAreaInsets();

  return (
    <Tab.Navigator
      screenOptions={({ route }) => ({
        tabBarIcon: ({ focused, color, size }) => {
          let iconName: keyof typeof Ionicons.glyphMap = "help-circle";

          if (route.name === "Chat") {
            iconName = focused ? "chatbubble-ellipses" : "chatbubble-ellipses-outline";
          } else if (route.name === "Code") {
            iconName = focused ? "code-slash" : "code-slash-outline";
          } else if (route.name === "Terminal") {
            iconName = focused ? "terminal" : "terminal-outline";
          }

          return <Ionicons name={iconName} size={size} color={color} />;
        },
        tabBarActiveTintColor: theme.palette.primary,
        tabBarInactiveTintColor: theme.palette.text.secondary,
        tabBarStyle: {
          backgroundColor: theme.palette.card,
          borderTopColor: theme.palette.border,
          height: 56 + insets.bottom,
          paddingBottom: insets.bottom,
          paddingTop: 6,
        },
        tabBarLabelStyle: {
          fontSize: 12,
          fontWeight: "700",
          marginBottom: 4,
        },
        headerShown: false,
      })}
    >
      <Tab.Screen name="Chat" component={ChatScreen} />
      <Tab.Screen name="Code" component={CodeScreen} />
      <Tab.Screen name="Terminal" component={TerminalScreen} />
    </Tab.Navigator>
  );
};

const DrawerRoot = () => {
  return (
    <Drawer.Navigator
      drawerContent={(props) => <CustomDrawerContent {...props} />}
      screenOptions={{
        header: (props) => <CustomHeader {...props} />,
        drawerStyle: { backgroundColor: theme.palette.card },
        drawerActiveTintColor: theme.palette.primary,
        drawerInactiveTintColor: theme.palette.text.primary,
      }}
    >
      <Drawer.Screen
        name="Home"
        component={TabNavigator}
        options={{ title: "k1w1-a0style", drawerLabel: "Home" }}
      />

      <Drawer.Screen
        name="Preview"
        component={PreviewScreen}
        options={{ title: "Preview", drawerLabel: "ðŸ‘ï¸ Preview" }}
      />

      <Drawer.Screen
        name="EnhancedBuild"
        component={EnhancedBuildScreen}
        options={{ title: "Build", drawerLabel: "ðŸ—ï¸ Build" }}
      />

      <Drawer.Screen
        name="AppStatus"
        component={AppStatusScreen}
        options={{ title: "Status", drawerLabel: "ðŸ“Š Status" }}
      />

      <Drawer.Screen
        name="GitHubRepos"
        component={GitHubReposScreen}
        options={{ title: "GitHub Repos", drawerLabel: "ðŸ™ GitHub Repos" }}
      />

      <Drawer.Screen
        name="Connections"
        component={ConnectionsScreen}
        options={{ title: "Verbindungen", drawerLabel: "ðŸ”Œ Verbindungen" }}
      />

      <Drawer.Screen
        name="Settings"
        component={SettingsScreen}
        options={{ title: "Einstellungen", drawerLabel: "âš™ï¸ Einstellungen" }}
      />

      <Drawer.Screen
        name="Diagnostic"
        component={DiagnosticScreen}
        options={{ title: "Diagnose", drawerLabel: "ðŸ§ª Diagnose" }}
      />

      <Drawer.Screen
        name="AppInfo"
        component={AppInfoScreen}
        options={{ title: "App Info", drawerLabel: "â„¹ï¸ App Info" }}
      />
    </Drawer.Navigator>
  );
};

const AppNavigation = () => {
  return (
    <NavigationContainer>
      <StatusBar style="light" backgroundColor={theme.palette.card} />

      <Stack.Navigator screenOptions={{ headerShown: false }}>
        <Stack.Screen name="Root" component={DrawerRoot} />
        <Stack.Screen
          name="PreviewFullscreen"
          component={PreviewFullscreenScreen}
          options={{ presentation: "modal" }}
        />
      </Stack.Navigator>
    </NavigationContainer>
  );
};

export default function App() {
  return (
    <GestureHandlerRootView style={{ flex: 1 }}>
      <SafeAreaProvider>
        <ErrorBoundary>
          <TerminalProvider>
            <AIProvider>
              <ProjectProvider>
                <GitHubProvider>
                  <AppNavigation />
                </GitHubProvider>
              </ProjectProvider>
            </AIProvider>
          </TerminalProvider>
        </ErrorBoundary>
      </SafeAreaProvider>
    </GestureHandlerRootView>
  );
}
